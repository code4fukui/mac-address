<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">
<title>Wi-Fiパケットセンシングによる時間帯別混雑状況目安</title>
</head><body>

<h1 id=h1></h1>
<main id=main></main>

<hr>
DATA: <a href=https://github.com/code4fukui/mac-address>金沢大学のwi-fiパケットセンシングにより取得したデータをオープンデータとしたもの</a><br>
<a href=https://github.com/code4fukui/mac-address>src on GitHub</a>

<script type="module">
import { CSV } from "https://js.sabae.cc/CSV.js";
import { cr } from "https://js.sabae.cc/cr.js";
import { move2count } from "./move2count.js";
import { showLineChart } from "./showLineChart.js";
import { DateTime } from "https://js.sabae.cc/DateTime.js";
import { rnd } from "https://js.sabae.cc/rnd.js";

h1.textContent = document.title;

// No.,エリア,業種,施設名(日本語),施設名(ローマ字),緯度,経度
const index = await CSV.fetchJSON("00_M5_facility list.csv");
const nsel = 4;
const sels = [];
for (let i = 0; i < nsel; i++) {
  const sel = cr("select", main);
  cr("option", sel).textContent = "-";
  for (const i of index) {
    const op = cr("option", sel);
    op.textContent = i["エリア"] + " " + i["施設名(日本語)"];
    op.value = i["No."];
  }
  sel.value = index[rnd(index.length)]["No."];
  sels.push(sel);
}

const div = cr("div", main);

const cache = {};
const cachedFetch = async (url) => {
  if (cache[url]) cache[url];
  try {
    const data = await CSV.fetchJSON(url);
    cache[url] = data;
    return data;
  } catch (e) {
    console.log(e);
  }
  cache[url] = null;
  return null;
};

const show = async () => {
  div.innerHTML = "";
  const series = [];
  for (const sel of sels) {
    const no = sel.value;
    if (no == "-") continue;
    const url = "move/" + no + ".csv";
    const data = await cachedFetch(url);
    if (!data) continue;
    const cnt = move2count(data);
    const name = index.find(i => i["No."] == no)["施設名(日本語)"];
    series.push({ name, data: cnt.map(i => ([new DateTime(i.dt).getTime(), i.cnt])) });
  }

  console.log(series);
  const height = 500;
  showLineChart(div, series, height);
};
show();
sels.forEach(i => i.oninput = show);

</script>
<style>
a {
  color: gray !important;
}
</style>

</body></html>
